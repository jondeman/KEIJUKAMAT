<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Työstetään... | KonseptiKeiju</title>
    <link rel="stylesheet" href="static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app">
        <header class="header">
            <a href="index.html" class="logo">
                <img class="logo-icon" src="wand.png" alt="KonseptiKeiju logo">
                <span class="logo-text">KonseptiKeiju</span>
            </a>
        </header>

        <main class="main status-main">
            <section class="status-hero">
                <h1 id="status-title">Konseptit työn alla...</h1>
                <p id="status-company" class="company-name"></p>
                <p class="status-note">
                    Voit nyt halutessasi sulkea selaimen, toimitan tulokset sinulle sähköpostitse tuota pikaa!
                </p>
            </section>

            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <span id="progress-text" class="progress-text">0%</span>
            </div>

            <div class="log-stream">
                <div class="log-header">Ajossa nyt</div>
                <pre id="log-lines" class="log-lines">Odotetaan tietoja...</pre>
            </div>

            <div class="log-stream">
                <div class="log-header">Diagnostiikka</div>
                <pre id="diagnostics" class="log-lines">Odotetaan tietoja...</pre>
            </div>

            <div class="log-stream">
                <div class="log-header">Raaka loki</div>
                <pre id="raw-logs" class="log-lines">Odotetaan tietoja...</pre>
            </div>

            <div class="phases">
                <div class="phase" data-phase="validate">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Validoidaan</span>
                </div>
                <div class="phase" data-phase="check_archive">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Tarkistetaan arkisto</span>
                </div>
                <div class="phase" data-phase="research">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Tutkitaan brändiä</span>
                </div>
                <div class="phase" data-phase="strategize">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Strateginen suunnittelu</span>
                </div>
                <div class="phase" data-phase="create">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Luodaan konsepteja</span>
                </div>
                <div class="phase" data-phase="visualize">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Luodaan visuaaleja</span>
                </div>
                <div class="phase" data-phase="compose_pitch">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Kirjoitetaan pitch</span>
                </div>
                <div class="phase" data-phase="package">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Kootaan paketti</span>
                </div>
                <div class="phase" data-phase="deliver">
                    <span class="phase-icon">○</span>
                    <span class="phase-name">Toimitetaan</span>
                </div>
            </div>

            <div id="results" class="results hidden">
                <h2>Konseptit ovat valmiit!</h2>
                <div class="result-cards">
                    <div class="result-card">
                        <h3>Varma valinta</h3>
                        <p id="concept-1-title"></p>
                    </div>
                    <div class="result-card">
                        <h3>Haastaja</h3>
                        <p id="concept-2-title"></p>
                    </div>
                    <div class="result-card">
                        <h3>Kuunlento</h3>
                        <p id="concept-3-title"></p>
                    </div>
                </div>
                <a id="download-link" href="#" class="download-btn">
                    Lataa paketti
                    <span>→</span>
                </a>
            </div>

            <div id="error" class="error hidden">
                <h2>Jotain meni pieleen</h2>
                <p id="error-message"></p>
                <a href="index.html" class="retry-btn">Yritä uudelleen</a>
            </div>
        </main>

        <footer class="footer">
            <p>Run ID: <code id="run-id"></code></p>
        </footer>
    </div>

    <script src="config.js"></script>
    <script>
        const runId = new URLSearchParams(window.location.search).get('run_id');
        const apiBase = (window.KONSEPTIKEIJU_API_BASE || '').replace(/\/+$/, '');
        const basePath = window.location.pathname.replace(/[^/]*$/, '');
        
        if (!runId) {
            window.location.href = `${basePath}index.html`;
        }
        
        document.getElementById('run-id').textContent = runId;
        
        const phaseProgress = {
            'input': 0,
            'validate': 5,
            'check_archive': 10,
            'research': 30,
            'strategize': 40,
            'create': 60,
            'visualize': 80,
            'compose_pitch': 90,
            'package': 95,
            'deliver': 98,
            'done': 100,
            'error': -1
        };
        
        const phaseOrder = ['validate', 'check_archive', 'research', 'strategize', 'create', 'visualize', 'compose_pitch', 'package', 'deliver'];
        
        function updatePhases(currentPhase) {
            const currentIndex = phaseOrder.indexOf(currentPhase);
            
            phaseOrder.forEach((phase, index) => {
                const el = document.querySelector(`[data-phase="${phase}"]`);
                if (!el) return;
                
                const icon = el.querySelector('.phase-icon');
                
                if (index < currentIndex) {
                    el.classList.add('complete');
                    el.classList.remove('active');
                    icon.textContent = '✓';
                } else if (index === currentIndex) {
                    el.classList.add('active');
                    el.classList.remove('complete');
                    icon.textContent = '◉';
                } else {
                    el.classList.remove('active', 'complete');
                    icon.textContent = '○';
                }
            });
        }
        
        function updateProgress(phase) {
            const progress = phaseProgress[phase] || 0;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${progress}%`;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleTimeString('fi-FI', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleString('fi-FI');
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`${apiBase}/api/logs/${runId}?limit=20`);
                if (response.status === 404) {
                    const logEl = document.getElementById('log-lines');
                    logEl.textContent = 'Runia ei löydy (palvelu on voinut käynnistyä uudelleen).';
                    return;
                }
                const data = await response.json();
                const lines = (data.entries || []).map((entry) => {
                    const time = formatTime(entry.timestamp);
                    const level = entry.level ? entry.level.toUpperCase() : 'INFO';
                    const message = entry.event || entry.message || entry.phase || '';
                    const error = entry.error || entry.error_message || '';
                    const suffix = error ? ` (${error})` : '';
                    return `${time} ${level} ${message}${suffix}`.trim();
                });
                const logEl = document.getElementById('log-lines');
                logEl.textContent = lines.length ? lines.join('\n') : 'Odotetaan tietoja...';
            } catch (error) {
                const logEl = document.getElementById('log-lines');
                logEl.textContent = 'Lokien haku epäonnistui, yritetään uudelleen...';
            }
        }

        async function fetchDiagnostics() {
            try {
                const response = await fetch(`${apiBase}/api/diagnostics/${runId}?limit=10`);
                if (response.status === 404) {
                    const diagEl = document.getElementById('diagnostics');
                    diagEl.textContent = 'Diagnostiikkaa ei löydy (run puuttuu).';
                    return;
                }
                const data = await response.json();
                const lines = [];
                lines.push(`Current phase: ${data.current_phase || '-'}`);
                lines.push(`Updated at: ${formatDateTime(data.updated_at) || '-'}`);
                lines.push(`Running: ${data.running ? 'yes' : 'no'}`);
                if (data.error_message) {
                    lines.push(`Last error: ${data.error_message}`);
                }
                lines.push('');
                lines.push('Recent phases:');
                (data.phase_history || []).forEach((phaseItem) => {
                    const phase = phaseItem.phase || '-';
                    const started = formatDateTime(phaseItem.started_at);
                    const completed = formatDateTime(phaseItem.completed_at);
                    const success = phaseItem.success;
                    const status = success === false ? 'failed' : (success === true ? 'ok' : 'running');
                    lines.push(
                        `${phase} | start: ${started || '-'} | end: ${completed || '-'} | ${status}`
                    );
                });

                const diagEl = document.getElementById('diagnostics');
                diagEl.textContent = lines.join('\n');
            } catch (error) {
                const diagEl = document.getElementById('diagnostics');
                diagEl.textContent = 'Diagnostiikan haku epäonnistui, yritetään uudelleen...';
            }
        }

        async function fetchRawLogs() {
            try {
                const response = await fetch(`${apiBase}/api/logs/${runId}/raw?limit=200`);
                if (response.status === 404) {
                    const rawEl = document.getElementById('raw-logs');
                    rawEl.textContent = 'Raakalokia ei löydy (run puuttuu).';
                    return;
                }
                const data = await response.json();
                const lines = data.lines || [];
                const rawEl = document.getElementById('raw-logs');
                rawEl.textContent = lines.length ? lines.join('\n') : 'Odotetaan tietoja...';
            } catch (error) {
                const rawEl = document.getElementById('raw-logs');
                rawEl.textContent = 'Raakalokin haku epäonnistui, yritetään uudelleen...';
            }
        }
        
        async function checkStatus() {
            try {
                const response = await fetch(`${apiBase}/api/status/${runId}`);
                if (response.status === 404) {
                    document.getElementById('status-title').textContent = 'Runia ei löytynyt';
                    document.getElementById('error').classList.remove('hidden');
                    document.getElementById('error-message').textContent =
                        'Render on todennäköisesti restartannut palvelun ja runin tiedot katosivat. Käynnistä ajo uudelleen.';
                    return; // Stop polling
                }
                const data = await response.json();
                
                if (data.company_name) {
                    document.getElementById('status-company').textContent = data.company_name;
                }
                
                const phase = data.current_phase;
                updatePhases(phase);
                updateProgress(phase);
                
                if (phase === 'done') {
                    document.getElementById('status-title').textContent = 'Konseptit ovat valmiit!';
                    document.getElementById('results').classList.remove('hidden');
                    
                    if (data.concepts) {
                        data.concepts.forEach((concept, i) => {
                            document.getElementById(`concept-${i + 1}-title`).textContent = concept.title;
                        });
                    }
                    
                    if (data.download_url) {
                        const downloadLink = document.getElementById('download-link');
                        downloadLink.href = data.download_url.startsWith('http')
                            ? data.download_url
                            : `${apiBase}${data.download_url}`;
                    }
                    
                    return; // Stop polling
                }
                
                if (phase === 'error') {
                    document.getElementById('status-title').textContent = 'Työ epäonnistui';
                    document.getElementById('error').classList.remove('hidden');
                    document.getElementById('error-message').textContent = data.error_message || 'An unexpected error occurred.';
                    return; // Stop polling
                }
                
                // Continue polling
                await fetchLogs();
                await fetchDiagnostics();
                await fetchRawLogs();
                setTimeout(checkStatus, 2000);
                
            } catch (error) {
                console.error('Status check failed:', error);
                await fetchLogs();
                await fetchDiagnostics();
                await fetchRawLogs();
                setTimeout(checkStatus, 5000); // Retry with longer delay
            }
        }
        
        // Start polling
        checkStatus();
    </script>
</body>
</html>
